{% extends "layouts/base-responsive.html" %}
{% from 'includes/seo_macros.html' import seo_meta %}

{% block head_meta %}
  {{ seo_meta(
    title=title,
    description=description,
    keywords=page_keywords,
    image_url=request.host_url ~ 'static/assets/img/favicon.png',
    page_url=page_url
  ) }}
{% endblock %}

{% block body_class %}dataAvailability-page{% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

	<link rel="stylesheet" href="/static/assets/css/dashboard.css">
	<link rel="stylesheet" href="/static/assets/css/dataAvailability.css">

{% endblock stylesheets %}

{% block content %}

		<!-- Define page content -->
	<div class="content" style="min-height: calc(100% - 130px);">
		<div class="page-inner">
			<h1 class="sr-only">Copernicus Sentinel Data Availability</h1>
			<!-- Breadcrumb -->
			<div class="page-header">
				<h4 class="page-title">Data Availability</h4>
				<ul class="breadcrumbs">
					<li class="nav-home">
						<a href="/index.html">
							<i class="flaticon-home"></i>
						</a>
					</li>
					<li class="separator">
						<i class="flaticon-right-arrow"></i>
					</li>
					<li class="nav-item">
						<a href="#">Detail Data Availability</a>
					</li>
				</ul>
			</div>

			<!-- Datatake details panel -->
			<div class="modal fade" id="showDatatakeDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content" style="background: #006B7C">
						<div class="modal-header no-bd">
							<h5 class="modal-title">
								<span class="fw-mediumbold">View</span>
								<span class="fw-light">Datatake details</span>
							</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true" style="color: white">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<form>
								<div id="datatake-details">
								</div>
							</form>
						</div>
						<div class="modal-footer no-bd">
							<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>
			<!-- Completeness Table Modal -->
			<div class="modal fade" id="completenessTableModal" tabindex="-1" role="dialog">
				<div class="modal-dialog modal-md" role="document">
					<div class="modal-content" style="background: #006B7C; color: #fff;">
						<div class="modal-header no-bd">
							<h5 class="modal-title">
							<span class="fw-mediumbold">Datatake</span>
							<span class="fw-light">Details</span>
							</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true" style="color: white">&times;</span>
							</button>
						</div>

						<div class="modal-body">
							<div class="d-flex justify-content-center">
								<div class="table-responsive" style="max-width: 80%;">
									<table class="custom-box-table-sm table-m text-center">
										<thead style="border-bottom: 2px solid #fff;">
										<tr>
											<th>Product type</th>
											<th>Status(%)</th>
										</tr>
										</thead>
										<tbody id="modalInfoTableBody"></tbody>
									</table>
									<div id="modalPaginationControls" class="pagination-row"></div>
								</div>
							</div>
						</div>

						<div class="modal-footer no-bd">
							<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>
			<!-- Collapsible description panel -->
			<div class="row">
				<div class="card-body" style="padding-bottom: 0.0rem !important">
					<div class="flex flex-column faq-section">
						<div class="row">
							<div class="col-md-12">
								<div id="accordion">
									<div class="card">
										<div class="card-header" id="heading-description">
											<h5 class="mb-0">
												<a role="button" data-toggle="collapse" href="#description"
												   aria-expanded="false" aria-controls="description"
												   style="color: white; text-decoration: none">
													&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description
												</a>
											</h5>
										</div>
										<div id="description" class="collapse hide" data-parent="#accordion"
											 aria-labelledby="heading-description">
											<div class="card-body">
												This page displays all datatakes from the past three months, 
												including those scheduled up to 23:59:59 of the following day. 
												For each datatake, key information is shown—such as the acquisition 
												platform, sensor mode, acquisition status, and total publication 
												completeness (expressed as a percentage)—with updates refreshed hourly.
												You can filter the records by mission and, optionally, by satellite. 
												Alternatively, filtering by satellite alone is also possible. For 
												Sentinel-5P, the satellite selector is disabled, as only one satellite is available. 
												Additional filters include a custom date range (aligned with the time filter 
												selected at the top of the page), as well as direct searches by datatake ID.
												Please note: the selected "from"-"to" time range applies to the start date of the datatakes.
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Table container -->
			<div class="row">
				<div class="col-12 datatakes-window">
					<div class="card datatakes-card">
						<div class="card-body">
							<div class="row">
									<!-- Left Panel -->
								<div class="col-12 col-md-3 left-panel d-flex flex-column mb-3 mb-md-0">
									<div class="filter-panel p-3 flex-grow-1">
										<!-- Filter by Mission -->
										<form method="GET" class="d-flex flex-column gap-2">
											<select id="mission-select" class="form-control" onchange="datatakes.filterSidebarItems()">
												<option value="">All Missions</option>
												<option value="S1"  {{ 'selected' if mission=='S1' }}>Sentinel 1</option>
												<option value="S2"  {{ 'selected' if mission=='S2' }}>Sentinel 2</option>
												<option value="S3"  {{ 'selected' if mission=='S3' }}>Sentinel 3</option>
												<option value="S5"  {{ 'selected' if mission=='S5' }}>Sentinel 5P</option>
											</select>
											<select id="satellite-select" class="form-control" onchange="datatakes.filterSidebarItems()">
												<option value="">All Satellites</option>
												<option value="S1A" {{ 'selected' if satellite=='S1A' }}>S1A</option>
												<option value="S1C" {{ 'selected' if satellite=='S1C' }}>S1C</option>
												<option value="S2A" {{ 'selected' if satellite=='S2A' }}>S2A</option>
												<option value="S2B" {{ 'selected' if satellite=='S2B' }}>S2B</option>
												<option value="S2C" {{ 'selected' if satellite=='S2C' }}>S2C</option>
												<option value="S3A" {{ 'selected' if satellite=='S3A' }}>S3A</option>
												<option value="S3B" {{ 'selected' if satellite=='S3B' }}>S3B</option>
											</select>
		
											<!-- Inline Date Range -->
											<!-- Dates -->
											<div>
												<label>From</label>
												<input type="datetime-local" name="fromdate" class="form-control"
													value="{{ from_date }}">
											</div>

											<div>
												<label>To</label>
												<input type="datetime-local" name="todate" class="form-control"
													value="{{ to_date }}">
											</div>
											<button type="submit" class="btn btn-outline-secondary" id="resetFilterButton">Reset Filter</button>
											<input
												type="text"
												id="searchInput"
												class="form-control mb-3"
												placeholder="Search by id..."
												oninput="datatakes.filterSidebarItems()"
											>
										</form>
										<!-- Sidebar for datatakes -->												
										<ul class="list-unstyled" id="dataList">
										{% if normalized_datatakes %}
											{% set firstPageDatatakes = normalized_datatakes[:BATCH_SIZE] %}
											{% for dt in firstPageDatatakes %}
												{% set status = dt.acquisition_status|default("unknown")|lower %}
												<li>
													<div class="container-border {{ loop.first and 'selected' or '' }}"
														style="display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0.75rem;cursor:pointer;"
														data-id="{{ dt.id }}">
														<a href="#" class="filter-link {{ loop.first and 'selected' or '' }}" onclick="event.preventDefault();">
															{{ dt.id }}
														</a>
														<div class="status-circle-dt-{{ status }}"></div>
													</div>
												</li>
											{% endfor %}
										{% else %}
											<li><em>No datatakes found</em></li>
										{% endif %}
										</ul>
										<button class="loadMore" id="loadMoreBtn">
											Load More
										</button>
									</div>
								</div>
								<!-- Main Content -->
								<div class="col-12 col-md-9 d-flex flex-column">
									<div class="datatakes-container flex-grow-1">
										<!-- Loading Spinner -->
										<div class="chart-container" style="position: relative;">
											<div id="spinner" class="spinner-overlay">
												<div class="spinner-bar"> </div>
											</div>
											<!-- Charts Section -->
											<h4><span class="title-text"></span></h4>
											<p class="text-left"></p>

											<div class="row donut-charts-wrapper justify-content-center text-center">
												<!-- Donut Chart 1: Acquisition -->
												<div class="col-md-6 mb-3 d-flex flex-column align-items-center">
													<div id="acquisitionDonutChart" class="donut-chart"></div>
												</div>

												<!-- Donut Chart 2: Publication -->
												<div class="col-md-6 mb-3 d-flex flex-column align-items-center">
													<div id="publicationDonutChart" class="donut-chart"></div>
												</div>
											</div>
										</div>
										
										<!-- Table and Legend Section -->
										 {% if datatake_details %}
											<div class="alert alert-info mt-3">
												<h5>Datatake {{ datatake_details['_source'].datatake_id }}</h5>
												<pre>{{ datatake_details | tojson(indent=2) }}</pre>
											</div>
										{% endif %}
										<div class="table-legend-wrapper mt-3">
											<!-- Datatake Details Section -->
											<div id="tableSection" class="mt-2" style="display: none;">
													<div id="table-container">
															<div class="custom-box-table-container table-responsive" style="position: relative;">
																<button class="close-btn" id="closeTableButton" aria-label="Close table">✖</button>
																	<table id="timelineTable" class="custom-box-table table-sm">
																			<thead>
																					<tr>
																							<th>Data Take ID</th>
																							<th>Platform</th>
																							<th>Start Date</th>
																							<th>Stop Date</th>
																							<th>
																									<div class="custom-tooltip">
																											Acquisition
																											<sup><span
																															class="tooltip-icon">ℹ</span></sup>
																											<div
																													class="tooltip-text">
																													<strong>Acquisition
																															Status</strong><br><br>
																													This column
																													reports the
																													status of
																													datatake
																													acquisition from
																													the Ground
																													Station.
																													Possible values
																													are:<br><br>
																													<strong>PLANNED:</strong>
																													if the datatake
																													is going to be
																													acquired in the
																													future<br>
																													<strong>PROCESSING:</strong>
																													after the
																													contact with the
																													ground station,
																													and the
																													processing of
																													raw data is
																													ongoing<br>
																													<strong>ACQUIRED:</strong>
																													if the datatake
																													was successfully
																													acquired<br>
																													<strong>PARTIAL:</strong>
																													if the datatake
																													was acquired
																													only in part
																													(e.g., in case
																													of ground
																													station or
																													satellite
																													issues)<br>
																													<strong>UNAVAILABLE:</strong>
																													if the datatake
																													was lost during
																													downlink (e.g.,
																													in case of a
																													major issue
																													concerning the
																													ground station
																													or the
																													satellite)
																											</div>
																									</div>
																							</th>
																							<th>
																									<div class="custom-tooltip">
																											Publication
																											<sup><span
																															class="tooltip-icon">ℹ</span></sup>
																											<div
																													class="tooltip-text">
																													<strong>Publication
																															Status</strong><br><br>
																													This column
																													reports the
																													publication
																													status of
																													products
																													associated to a
																													datatake,
																													together with
																													their overall
																													completeness.
																													Possible values
																													are:<br><br>
																													<strong>PLANNED:</strong>
																													if the datatake
																													is going to be
																													processed and
																													published in the
																													future<br>
																													<strong>PROCESSING:</strong>
																													if the datatake
																													processing is
																													ongoing<br>
																													<strong>DELAYED:</strong>
																													if the datatake
																													processing is
																													taking more than
																													the nominal
																													time<br>
																													<strong>PUBLISHED:</strong>
																													if all expected
																													products were
																													successfully
																													published and
																													the average
																													completeness
																													exceeds 90%<br>
																													<strong>PARTIAL:</strong>
																													if not all
																													expected
																													products were
																													successfully
																													published,
																													and/or the
																													average
																													completeness is
																													below 90%<br>
																													<strong>UNAVAILABLE:</strong>
																													if no products
																													could be
																													published (e.g.,
																													in case of a
																													datatake lost
																													during downlink)
																											</div>
																									</div>
																							</th>
																							<th>Actions</th>
																					</tr>
																			</thead>
																			<tbody id="dataTableBody">
																				{% if datatakes %}
																					{% for dt in datatakes %}
																					<tr>
																					<td>{{ dt.id }}</td>
																					<td>{{ dt.platform or 'N/A' }}</td>
																					<td>
																						{{ dt.start_time[:16].replace('T', ' ') }}
																					</td>
																					<td>
																						{{ dt.stop_time[:16].replace('T', ' ') }}
																					</td>
																					<td>
																						<span class="status-circle status-{{ dt.acquisition_status|lower }}"></span>
																						{{ dt.acquisition_status or 'N/A' }}
																					</td>
																					<td>
																						<span class="status-circle status-{{ dt.publication_status|lower }}"></span>
																						{{ dt.publication_status or 'N/A' }}
																						{% if dt.publication_percent is defined %}
																						({{ dt.publication_percent }}%)
																						{% endif %}
																					</td>
																					<td>
																						<button class="btn btn-outline-info btn-sm"
																								onclick="openDataTake('{{ dt.id }}')">
																						Details
																						</button>
																					</td>
																					</tr>
																					{% endfor %}
																				{% else %}
																					<tr>
																					<td colspan="7" class="text-center text-muted">No datatakes available for the selected period.</td>
																					</tr>
																				{% endif %}
																			</tbody>
																	</table>
															</div>
													</div>
											</div>
											<!-- Completeness Status Legend -->
											<div class="completeness-status">
												<h5 class="comple-title mb-2">Completeness Status:</h5>
												<div class="legend-grid">
													<div class="legend-item d-flex align-items-center mb-1">
														<i class="status-circle-dt-planned me-2"></i>
														<span>Planned</span>
													</div>

													<div class="legend-item d-flex align-items-center mb-1">
														<i class="status-circle-dt-processing me-2"></i>
														<span>Processing</span>
													</div>

													<div class="legend-item d-flex align-items-center mb-1">
														<i class="status-circle-dt-acquired me-2"></i>
														<span>Acquired</span>
													</div>

													<div class="legend-item d-flex align-items-center mb-1">
														<i class="status-circle-dt-part me-2"></i>
														<span>Partial</span>
													</div>

													<div class="legend-item d-flex align-items-center mb-1">
														<i class="status-circle-dt-unavailable me-2"></i>
														<span>Unavailable</span>
													</div>
												</div>
											</div>
										</div>	
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

	<!-- Specific plugins scripts -->
	<!-- Datatables -->
	<script src="/static/assets/js/plugin/datatables/datatables.min.js"></script>

	<!-- Page related JS Class -->
	<script src="/static/assets/js/datatakes/datatakes.js"></script>
	<script id="server-data" type="application/json">
		{{ {
				"anomalies": anomalies | default([]),
				"datatakes": normalized_datatakes | default([]),
				"datatakes_for_ssr": datatakes_for_ssr | default([]),
				"quarter_authorized": quarter_authorized | default(false),
				"selected_period": selected_period | default(""),
				"generated_at": generated_at | default("")
			} | tojson }}
	</script>	
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const el = document.getElementById("server-data");
			if (!el) {
				console.warn("[DATA-AVAILABILITY] No server-data element found in DOM");
				return;
			}

			let serverData = {};
			try {
				serverData = JSON.parse(el.textContent);
			} catch (err) {
				console.error("[DATA-AVAILABILITY] Failed to parse server data:", err);
				return;
			}

			// Fallbacks
			serverData.datatakes = serverData.datatakes || [];
			serverData.anomalies = serverData.anomalies || [];

			// Initialize JS controller
			try {
				console.info("[DATA-AVAILABILITY] Initializing Datatakes controller...");
				window.datatakes = new Datatakes(serverData);
				window.datatakes.init();

				window.datatakes.initializeDefaultView?.();

			} catch (err) {
				console.error("[DATA-AVAILABILITY] Error initializing Datatakes:", err);
			}
		});
	</script>
	<script>
		function openDatatake(id) {
			document.getElementById("datatake_id").value = id;
			document.getElementById("detailsForm").submit();
		}
	</script>
	<script>
		$(function () {
				$('[data-toggle="tooltip"]').tooltip();
		});
	</script>

{% endblock javascripts %}