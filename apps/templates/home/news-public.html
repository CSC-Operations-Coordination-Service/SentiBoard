{% extends "layouts/base-responsive.html" %}
{% block title %}News{% endblock %}

{% block stylesheets %}
  {{ super() }}
  <style>
    .news-card {
      background-color: #006B7C;
      border: none;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .news-card img {
      object-fit: cover;
      width: 100%;
      height: 180px;
    }
    .news-card-body {
      flex: 1 1 auto;
      padding: 1rem;
      color: #fff;
    }
    .news-card-body a {
      color: #ffc107;
    }
    
    .page-item.active .page-link {
        color: #212529 !important;
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
    }

    a {
        color: #212529 !important;
    }
    a:focus, a:hover {
        color: #12b1bf !important;
        text-decoration: none !important;
    }
  </style>
{% endblock %}

{% block content %}

<div class="container" style="margin-top: 120px; margin-bottom: 80px;">
  <!-- Breadcrumb -->
  <div class="page-header">
    <h4 class="page-title">News</h4>
    <ul class="breadcrumbs">
      <li class="nav-home">
        <a href="/index_1.html">
          <i class="flaticon-home"></i>
        </a>
      </li>
      <li class="separator">
        <i class="flaticon-right-arrow"></i>
      </li>
      <li class="nav-item">
        <a href="#">News</a>
      </li>
    </ul>
  </div>

  <div class="row" id="news-card-container">
    <!-- Cards will be injected here -->
  </div>

  <!-- Pagination controls -->
  <nav aria-label="News pagination">
    <ul class="pagination justify-content-center mt-4" id="pagination-controls"></ul>
  </nav>
</div>
{% endblock %}

{% block javascripts%}
  {{ super() }}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $.getJSON("/api/news-images", function(imageList) {
      $.getJSON("/static/assets/json/custom-message.json", function(messages) {

        console.log("Messages:", messages);
        console.log("Image list:", imageList);

        if (!Array.isArray(messages)) messages = [messages];

        function getBorderColor(type) {
          switch (type) {
            case 'success': return '#28a745';
            case 'info':    return '#17a2b8';
            case 'warning': return '#ffc107';
            case 'danger':  return '#dc3545';
            default:        return '#006B7C';
          }
        }

        function getIcon(type) {
          switch (type) {
            case 'success': return 'fa-check-circle';
            case 'info':    return 'fa-info-circle';
            case 'warning': return 'fa-exclamation-circle';
            case 'danger':  return 'fa-exclamation-triangle';
            default:        return 'fa-bullhorn';
          }
        }

        function getRandomImageUrl() {
          if (!imageList.length) return null;
          const img = imageList[Math.floor(Math.random() * imageList.length)];
          return `/static/assets/img/news/${img}`;
        }

        const newsData = messages
          .filter(msg => msg.active)
          .map(msg => ({
            text: msg.text,
            link: msg.link || '',
            iconClass: getIcon(msg.type),
            color: getBorderColor(msg.type),
            image: getRandomImageUrl()
          }));

        const itemsPerPage = 6;
        let currentPage = 1;

        function renderCards(page) {
          const start = (page - 1) * itemsPerPage;
          const slice = newsData.slice(start, start + itemsPerPage);

          const cardsHtml = slice.map(n => `
            <div class="col-sm-12 col-md-6 col-lg-4 mb-4 d-flex">
              <div class="news-card w-100 shadow-sm">
                ${n.image ? `<img src="${n.image}" alt="News image">` : ''}
                <div class="news-card-body">
                  <h5><i class="fa ${n.iconClass}" style="color:${n.color};"></i> News</h5>
                  <p>${n.text}</p>
                  ${n.link
                    ? `<a href="${n.link}" class="text-warning" style="text-decoration: none;" target="_blank" rel="noopener">Read more</a>`
                    : ''
                  }
                </div>
              </div>
            </div>`).join('');

          $('#news-card-container').html(cardsHtml);
        }

        function renderPagination() {
          const pageCount = Math.ceil(newsData.length / itemsPerPage);
          let html = '';
          for (let i = 1; i <= pageCount; i++) {
            html += `
              <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
              </li>`;
          }
          $('#pagination-controls').html(html);
        }

        renderCards(currentPage);
        renderPagination();

        $('#pagination-controls').on('click', 'a', function(e) {
          e.preventDefault();
          const p = +$(this).data('page');
          if (p !== currentPage) {
            currentPage = p;
            renderCards(currentPage);
            renderPagination();
          }
        });
      });
    });
  </script>
{% endblock %}
