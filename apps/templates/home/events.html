{% extends "layouts/base-responsive.html" %}
{% from 'includes/seo_macros.html' import seo_meta %}

{% block head_meta %}
  {{ seo_meta(
    title="Sentinel Event Viewer | Copernicus Dashboard by ESA",
    description="Browse Sentinel event logs including anomalies, calibrations, and manoeuvres. See how real-time mission events affect satellite data availability.",
    keywords=get_keywords('events'),
    image_url=request.host_url ~ 'static/assets/img/favicon.png',
    page_url=page_url
  ) }}
{% endblock %}

{% block body_class %}events-page{% endblock %}

{% block content %}

  <!-- Viewport definition -->
    <meta charset="utf-8"/>
  <meta name="referrer" content="no-referrer-when-downgrade" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Define page content -->
  <div class="content" style="min-height: calc(100% - 130px);">
    <div class="page-inner">
      <h1 class="sr-only">Sentinel Mission Events Viewer | ESA Copernicus Dashboard</h1>
      <!-- Breadcrumb -->
      <div class="page-header">
        <h4 class="page-title">Events Viewer</h4>
        <ul class="breadcrumbs">
          <li class="nav-home">
                        <a href="/index.html">
                            <i class="flaticon-home"></i>
                        </a>
          </li>
          <li class="separator">
            <i class="flaticon-right-arrow"></i>
          </li>
          <li class="nav-item">
            <a href="#">Events</a>
          </li>
        </ul>
      </div>

      <!-- Collapsible description panel -->
      <div class="row">
        <div class="card-body" style="padding-bottom: 0.0rem !important">
          <div class="flex flex-column faq-section" style="margin-left: 21px; margin-right: 20px;">
            <div class="row">
              <div class="col-md-12">
                <div id="accordion">
                  <div class="card">
                    <div class="card-header" id="heading-description">
                      <h5 class="mb-0"><a role="button" data-toggle="collapse" href="#description" aria-expanded="false" aria-controls="description">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</a></h5>
                    </div>
                                        <div id="description" class="collapse hide" data-parent="#accordion"
                                             aria-labelledby="heading-description">
                      <div class="card-body">
                                                This view shows the events occurred on a given date and the possible
                                                impact on user products completeness. Events are categorized according 
                                                to the following issue types:<br>
                                                - Acquisition: issue occurring during the reception of the data at the
                                                ground station<br>
                                                - Calibration: issue occurred during sensor calibration<br>
                                                - Manoeuvre: issue occurred during the execution of a manoeuvre<br>
                                                - Production: issue occurred during data processing<br>
                                                - Satellite: issue due to instrument unavailability<br>
                                                When an occurrence is clicked, the bottom panel shows a list of potentially 
                                                impacted datatakes, determined by their sensing times, along with further 
                                                details about the event.
                                                The impact on datatake completeness is represented by the right-side coloured 
                                                circle. The "green" colour indicates that the total completeness is spared; 
                                                "orange" is used in case of medium impact; the "red" colour is used when the 
                                                datatake is lost.<br>
                                                Events can be filtered by mission, event type, satellite name (e.g., 'Sentinel-1A'), 
                                                or by entering a category of interest in the search box.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Calendar container -->
      <div class="row align-items-stretch">
        <div id="calendarLoadingSpinner" style="display:none;">Loading...</div>
        <!-- Main timeline control -->
        <div class="col-12 calendar-window">
          <div class="card calendar-card" >
            <div class="card-body">
              <!-- The Calendar control -->
                <div class="row  align-items-start">
                    <!-- Left Panel -->
                    <div class="col-12 col-lg-2 left-panel mb-4 mb-lg-0 matching-width">
                        <div class="filter-panel p-3">
                            <h3 class="mb-0">Events</h3>
                            <hr>
                            <div id="filtersContainer">
                              <div class="form-group mb-2">
                                <select id="missionSelect" class="form-control w-100">
                                  <option value="all" selected="true">All Missions</option>
                                  <option value="s1">Sentinel 1</option>
                                  <option value="s2">Sentinel 2</option>
                                  <option value="s3">Sentinel 3</option>
                                  <option value="s5">Sentinel 5P</option>
                                </select>
                              </div>
                              <div class="form-group mb-2">
                                <select id="eventTypeSelect" class="form-control w-100">
                                  <option value="all" selected>All Events</option>
                                  <option value="acquisition">Acquisition</option>
                                  <option value="calibration">Calibration</option>
                                  <option value="manoeuvre">Manoeuvre</option>
                                  <option value="production">Production</option>
                                  <option value="satellite">Satellite</option>
                              </select>
                              </div>
                              <div class="form-group mb-2">
                                <input type="text" class="form-control w-100" id="eventSearchInput"
                                placeholder="Search ..." />
                              </div>
                            </div>
                            <div class="form-group mb-2">
                              <button id="resetFilters" class="reset-button form-control">Reset</button>
                            </div>
                            <div class="event-legend mt-3">
                              <h4>Event Types</h4>
                              <div class="legend-item">
                                <i class="fas fa-broadcast-tower legend-icon event-acquisition"></i> Acquisition
                              </div>
                              <div class="legend-item">
                                <i class="fas fa-compass legend-icon event-calibration"></i> Calibration
                              </div>
                              <div class="legend-item">
                                <img src="/static/assets/img/joystick.svg" class="legend-icon event-manoeuvre image-icon" alt="Manoeuvre">
                                 Manoeuvre
                              </div>                                
                              <div class="legend-item">
                                <i class="fas fa-cog legend-icon event-production"></i> Production
                              </div>
                              <div class="legend-item">
                                <i class="fas fa-satellite-dish legend-icon event-satellite"></i> Satellite
                              </div>
                            </div>
                        </div>
                    </div>
                    <!-- Calendar Section -->
                     <div
                        id="anomalyData"
                        data-anomalies-by-date='{{ anomalies_by_date | tojson | safe }}'
                        data-anomalies='{{ json_anomalies | tojson | safe }}'
                        data-datatakes='{{ json_datatakes | tojson | safe }}'
                        data-quarter-authorized='{{ "true" if quarter_authorized else "false" }}'
                        data-events='{{ json_events | tojson | safe }}'
                      ></div>
                    <div class="col-12 col-lg-8 mb-4 mb-lg-0">
                      <div class="calendar-container">
                        <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                          <i id="prevMonth" class="fas fa-chevron-left fa-lg" role="button" tabindex="0" style="cursor: pointer;"></i>
                          <h1 id="monthYear" class="mb-0">
                            {{ current_month_name }} {{ current_year }}
                          </h1>
                          <i id="nextMonth" class="fas fa-chevron-right fa-lg" role="button" tabindex="0" style="cursor: pointer;"></i>
                        </div>

                        <div class="calendar-grid" id="calendarGrid">
                          {% for _ in range(first_day_offset) %}
                            <div class="calendar-day empty"></div>
                          {% endfor %}

                          {% for day in range(1, days_in_month + 1) %}
                            {% set date_str = "%04d-%02d-%02d" | format(current_year, current_month, day) %}
                            {% set day_events = [] %}
                            {% for e in json_events %}
                              {% if e.from[:10] == date_str %}
                                {% set _ = day_events.append(e) %}
                              {% endif %}
                            {% endfor %}

                            <div
                              class="calendar-day"
                              data-date="{{ date_str }}"
                              data-has-events="{{ 'true' if day_events else 'false' }}">
                              <span>{{ day }}</span>

                              {% if day_events %}
                                <div class="event-container">
                                  {% for e in day_events %}
                                    <div class="event" style="background-color: {{ e.color }}; color: {{ e.colorText }}; border: 1px solid {{ e.colorBorder }};" title="{{ e.description }}">
                                      <i class="fas fa-circle"></i> {{ e.title }}
                                    </div>
                                  {% endfor %}
                                </div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-lg-2 mb-4 matching-width">
                      <!-- Completeness Status (Legend) -->
                      <div class="completeness-status mb-3">
                        <h5 class="comple-title mb-2">Completeness Status:</h5>
                        <div class="legend-grid">
                          <div class="legend-completeness d-flex align-items-center mb-1">
                            <i class="status-circle-dt-planned me-2"></i>
                            <span>Planned</span>
                          </div>
                      
                          <div class="legend-completeness d-flex align-items-center mb-1">
                            <i class="status-circle-dt-processing me-2"></i>
                            <span>Processing</span>
                          </div>
                      
                          <div class="legend-completeness d-flex align-items-center mb-1">
                            <i class="status-circle-dt-acquired me-2"></i>
                            <span>Acquired</span>
                          </div>
                      
                          <div class="legend-completeness d-flex align-items-center mb-1">
                            <i class="status-circle-dt-part me-2"></i>
                            <span>Partial</span>
                          </div>
                      
                          <div class="legend-completeness d-flex align-items-center mb-1">
                            <i class="status-circle-dt-unavailable me-2"></i>
                            <span>Unavailable</span>
                          </div>
                        </div>
                      </div>
                      <div id="eventDetails" class="event-details p-3">
                        <h5 id="eventDetailsTitle">Event Details</h5>
                        <p id="noEventMessage">Select a date to see event details.</p>
                        <div id="eventDetailsContent"></div>
                      </div>
                    </div>
                </div>
            </div>
          </div>
      </div>
    </div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- Calendar plugin style -->
   
    <link rel="stylesheet" href="/static/assets/lib/calendar/css/calendarjs.min.css">
    <link rel="stylesheet" href="/static/assets/css/dashboard.css">
    <link rel="stylesheet" href="/static/assets/css/events.css">

  <!-- Calendar plugin scripts -->
  <script>
    window.iconMap = {{ icon_map | tojson | safe}};
    window.eventTypeMap = {{ event_type_map | tojson | safe}};
    window.anomaliesByDate = {{anomalies_by_date | tojson | safe}};
    const defaultYear = Number({{ current_year | int }}) || new Date().getFullYear();
    const defaultMonth = Number ({{ current_month | int }}) || (new Date().getMonth() + 1);

    const urlParams = new URLSearchParams(window.location.search);
    
    const yearParam = Number(urlParams.get('year'));
    const monthParam = Number(urlParams.get('month'));

    if(!isNaN(yearParam) && yearParam > 1970){
      window.currentYear = yearParam;
    } else {
      window.currentYear = defaultYear;
    }

    if(!isNaN(monthParam) && monthParam >=1 && monthParam <= 12){
      window.currentMonth = monthParam - 1;
    } else {
      window.currentMonth = defaultMonth -1;
    }
    console.log("[INIT PARAMS]", {year: window.currentYear, month0: window.currentMonth});
  </script>
  <script src="/static/assets/lib/calendar/src/calendarjs.min.js"></script>
  <script src="/static/assets/js/events/calendar.js"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", async function() {
      const spinner = document.getElementById('spinnerOverlay');
      if (spinner) spinner.style.display ="flex";

      try{
        await calendar.init();
        
        const fetchMonth = window.currentMonth + 1;
        const fetchYear = window.currentYear;

        console.log(`[FETCH INIT ] /events_data?year=${fetchYear}&month=${fetchMonth}`); 

        const res = await fetch(`/events_data?year=${fetchYear}&month=${fetchMonth}`);

        if (!res.ok) throw new Error("Failed to fetch initial events data");
        const data = await res.json();

        console.log(`[INIT] loaded ${data.count} anomalies for ${fetchMonth}/${data.year}`);

        //populate calendar data
        calendar.currentMonth = window.currentMonth;
        calendar.currentYear = window.currentYear;
        calendar.anomaliesByDate = data.anomalies_by_date || {};
        calendar.anomalies = Object.values(calendar.anomaliesByDate).flat();

        calendar.generateCalendar(calendar.currentMonth, calendar.currentYear); // JS months are 0-based
        
        updateURL(window.currentYear, window.currentMonth);
      }
      catch(err){
        console.error("Error fetching initial events:", err);
      } finally {
        if (spinner) spinner.style.display = "none";
      }

      function updateURL(year, month0){
        const month = month0 + 1;
        const params =  new URLSearchParams({year: year, month: month});
        history.replaceState(null, "", `?${params.toString()}`);
      }
      
      calendar.prevMonthButton.addEventListener("click", async () => {
        calendar.navigateMonth(-1)
        window.currentMonth = calendar.currentMonth;
        window.currentYear = calendar.currentYear;
        updateURL(window.currentYear, window.currentMonth);
        await reloadEvents();
      });

      calendar.nextMonthButton.addEventListener("click", async () => {
        calendar.navigateMonth(1)
        window.currentMonth = calendar.currentMonth;
        window.currentYear = calendar.currentYear;
        updateURL(window.currentYear, window.currentMonth);
        await reloadEvents();
      
      });

      async function reloadEvents(){
        if (spinner) spinner.style.display ="flex";
        try{
          const fetchMonth = window.currentMonth + 1;
          const fetchYear = window.currentYear;
          const res = await fetch(`/events_data?year=${fetchYear}&month=${fetchMonth}`);
          if (!res.ok) throw new Error("Failed to fetch initial events data");

          const data = await res.json();
          calendar.anomaliesByDate = data.anomalies_by_date || {};
          calendar.anomalies = Object.values(calendar.anomaliesByDate).flat();
          calendar.generateCalendar(calendar.currentMonth, calendar.currentYear); 
        } catch(err){
          console.error("Error reloading events:", err);
        } finally{
          if(spinner) spinner.style.display = "none";
        }
      }
    });
</script>
  
  <!-- Timeline plugin style -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.8.2/vis.min.css" />
  <link rel="stylesheet" href="/static/assets/css/dashboard.css" />

  <script>

    // Display selector
    $('#event-display-select').change(function() {
      if ($(this).val() === 'calendar') {
                document.getElementById('myCalendar').style.display = 'block';
                document.getElementById('myTimeline').style.display = 'none';
      }
    })
    
    // Filter anomalies
    $('#anomalies_filter_search').on('input', function(event) {
        calendar.filterEvents($(this).val());
    });

  </script>

{% endblock javascripts %}
